name: CI
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  DB_CONN_STR: postgresql+asyncpg://user:password@localhost:5432/app
  ORIGINS: http://127.0.0.1:8000
  JWT_SECRET_KEY: secret
  JWT_LIFETIME_SECONDS: 600
  PYTHONPATH: ./todos

jobs:
  ci:
    name: Setup
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: app
        ports:
          - 5432:5432
    steps:
    - name: Checkout working branch
      uses: actions/checkout@v3

    - name: Set up Python 3.9
      uses: actions/setup-python@v3
      with:
        python-version: 3.9

    - name: Install dependencies
      working-directory: .
      run: |
        pip3 install -r requirements.txt

    - name: Analysing the code with pylint
      working-directory: .
      run: |
        pip3 install pylint pylint-pydantic pylint_pytest_plugin pylint-exit
        pylint . || pylint-exit --fail-under=1 --error-fail $?

    - name: Analysing the code with Bandit
      working-directory: .
      run: |
        pip3 install bandit
        bandit -c bandit.yaml -r .

    - name: Create tables
      working-directory: .
      run: python3 todos/scripts/init_db.py

    - name: Initial data
      working-directory: .
      run: |
        python3 todos/scripts/initial_data.py

    - name: Initiate test user
      working-directory: .
      run: |
        python3 todos/tests/scripts/initiate_test_user.py

    - name: Test
      run: |
        pip3 install pytest pytest-asyncio httpx 'asgi-lifespan==2.*'
        pytest .